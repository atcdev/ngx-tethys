{"version":3,"file":"file-drop.component.js","sourceRoot":"","sources":["../../.tmp/uploader/file-drop.component.ts"],"names":[],"mappings":"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","sourcesContent":["import { Component, OnInit, ElementRef, Renderer2, Output, EventEmitter, HostBinding, Input, NgZone, OnDestroy } from '@angular/core';\nimport { mimeTypeConvert } from './util';\nimport { fromEvent, Subject } from 'rxjs';\nimport { takeUntil, filter, map, mapTo, tap, debounceTime, auditTime } from 'rxjs/operators';\n\n@Component({\n    selector: '[thyFileDrop]',\n    template: `\n        <ng-content></ng-content>\n    `\n})\nexport class ThyFileDropComponent implements OnInit, OnDestroy {\n    _state = {\n        isDragOver: false,\n        isCustomClassName: false,\n        acceptType: '',\n        isNeedCheckTypeAccept: false\n    };\n\n    @Input() thyFileDropClassName: string;\n\n    @Input()\n    set thyAcceptType(value: Array<string> | string) {\n        this._state.acceptType = mimeTypeConvert(value);\n        this._state.isNeedCheckTypeAccept = !!value;\n    }\n\n    @Output() thyOnDrop = new EventEmitter();\n\n    @HostBinding('class.drop-over')\n    get isDragOver() {\n        return this._state.isDragOver;\n    }\n\n    private ngUnsubscribe$ = new Subject();\n\n    constructor(private elementRef: ElementRef, private renderer: Renderer2, private ngZone: NgZone) {}\n\n    ngOnInit(): void {\n        this._state.isCustomClassName = !!this.thyFileDropClassName;\n        this.ngZone.runOutsideAngular(() => {\n            fromEvent(this.elementRef.nativeElement, 'dragenter')\n                .pipe(\n                    takeUntil(this.ngUnsubscribe$),\n                    tap((event: any) => {\n                        event.preventDefault();\n                    }),\n                    filter(event => event.dataTransfer.items && event.dataTransfer.items.length > 0),\n                    filter(this.checkRejectFolderAndHtmlElement.bind(this)),\n                    filter(this.checkOptionAcceptType.bind(this))\n                )\n                .subscribe(() => {\n                    this.ngZone.run(() => {\n                        this._state.isDragOver = true;\n                        this._toggleDropOverClassName();\n                    });\n                });\n\n            fromEvent(this.elementRef.nativeElement, 'dragover')\n                .pipe(takeUntil(this.ngUnsubscribe$))\n                .subscribe((event: any) => {\n                    event.preventDefault();\n                });\n\n            fromEvent(this.elementRef.nativeElement, 'dragleave')\n                .pipe(takeUntil(this.ngUnsubscribe$))\n                .subscribe((event: any) => {\n                    this.ngZone.run(() => {\n                        if (!this.elementRef.nativeElement.contains(event.fromElement)) {\n                            this._backToDefaultState();\n                            this._toggleDropOverClassName();\n                        }\n                    });\n                });\n\n            fromEvent(this.elementRef.nativeElement, 'drop')\n                .pipe(\n                    takeUntil(this.ngUnsubscribe$),\n                    tap((event: any) => {\n                        event.preventDefault();\n                    }),\n                    filter(event => event.dataTransfer.files && event.dataTransfer.files.length > 0),\n                    filter(this.checkRejectFolderAndHtmlElement.bind(this)),\n                    filter(this.checkOptionAcceptType.bind(this))\n                )\n                .subscribe((event: any) => {\n                    this.ngZone.run(() => {\n                        if (!this._state.isDragOver) {\n                            console.error('ngx-tethys Error: Uploaded files that do not support extensions.');\n                            return;\n                        }\n\n                        this.thyOnDrop.emit({\n                            files: event.dataTransfer.files,\n                            nativeEvent: event\n                        });\n                        this._backToDefaultState();\n                        this._toggleDropOverClassName();\n                    });\n                });\n        });\n    }\n\n    private checkRejectFolderAndHtmlElement(event: any) {\n        // 排除文件夹和HTML元素拖拽\n        const items = event.dataTransfer.items;\n        let res = true;\n        for (let index = 0; index < items.length; index++) {\n            const element = items[index];\n            if (element.kind !== 'file' || element.type === '') {\n                res = false;\n            }\n        }\n        return res;\n    }\n\n    private checkOptionAcceptType(event: any) {\n        const items = event.dataTransfer.items;\n        let res = true;\n        if (this._state.isNeedCheckTypeAccept) {\n            for (let index = 0; index < items.length; index++) {\n                const element = items[index];\n                if (this._state.acceptType.indexOf(element.type) === -1) {\n                    res = false;\n                }\n            }\n        }\n        return res;\n    }\n\n    private _toggleDropOverClassName() {\n        if (this._state.isCustomClassName) {\n            if (this._state.isDragOver) {\n                this.renderer.addClass(this.elementRef.nativeElement, this.thyFileDropClassName);\n            } else {\n                this.renderer.removeClass(this.elementRef.nativeElement, this.thyFileDropClassName);\n            }\n        }\n    }\n\n    private _backToDefaultState() {\n        this._state.isDragOver = false;\n    }\n\n    ngOnDestroy(): void {\n        this.ngUnsubscribe$.next();\n        this.ngUnsubscribe$.complete();\n    }\n}\n"]}